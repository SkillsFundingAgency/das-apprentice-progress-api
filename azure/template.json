{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json",
  "contentVersion": "1.0.0.0",
  "parameters": {
      "resourceEnvironmentName": {
          "type": "string"
      },
      "environmentName": {
          "type": "string"
      },
      "serviceName": {
          "type": "string"
      },
      "sharedEnvResourceGroup": {
          "type": "string"
      },
      "customHostName": {
          "type": "string"
      },
      "configurationStorageConnectionString": {
          "type": "securestring"
      },
      "keyVaultCertificateName": {
          "type": "string"
      },
      "loggingRedisConnectionString": {
          "type": "securestring"
      },
      "loggingRedisKey": {
          "type": "string"
      },
      "tags": {
          "type": "object"
      },
      "resourceGroupLocation": {
          "type": "string"
      },
      "sharedBackEndAppServicePlanName": {
          "type": "string"
      },
      "sharedServiceBusName": {
          "type": "string"
      },
      "backEndAccessRestrictions": {
          "type": "array"
      },
      "sharedBackEndSubnetResourceId": {
          "type": "string"
      },
      "sharedStorageAccountConnectionString": {
        "type": "securestring"
      },
      "sharedKeyVaultName": {
          "type": "string"
      },
      "sharedSQLServerName": {
          "type": "string"
      },
      "sharedEnvVirtualNetworkName": {
          "type": "string"
      },
      "subnetObject": {
          "type": "object"
      },
      "subnetServiceEndpointList": {
          "type": "array"
      },
      "subnetDelegations": {
          "type": "array"
      },
      "workerAccessRestrictions": {
          "type": "array"
      },
      "appServicePlanInstances": {
          "type": "int",
          "defaultValue": 1
      },
      "appServicePlanSize": {
          "type": "string",
          "defaultValue": "1"
      },
      "functionConfigNames": {
          "type": "string",
          "defaultValue": "SFA.DAS.ApprenticeProgress.Functions"
      },
      "elasticPoolName": {
          "type": "string",
          "defaultValue": ""
      },
      "databaseSkuName": {
          "type": "string",
          "defaultValue": "S0"
      },
      "databaseTier": {
          "type": "string",
          "defaultValue": "Standard"
      },
      "logAnalyticsSubscriptionId": {
          "type": "string",
          "defaultValue": "[subscription().subscriptionId]"
      },
      "sharedManagementResourceGroup": {
          "type": "string"
      },
      "logAnalyticsWorkspaceName": {
          "type": "string"
      },
      "utcValue": {
          "type": "string",
          "defaultValue": "[utcNow()]"
      },
      "SharedServiceBusFqdn": {
        "type": "string"
      },
      "serviceBusConnectionString": {
        "type": "securestring"
    }
  },
  "variables": {
      "deploymentUrlBase": "https://raw.githubusercontent.com/SkillsFundingAgency/das-platform-building-blocks/master/templates/",
      "resourceNamePrefix": "[toLower(concat('das-', parameters('resourceEnvironmentName'),'-', parameters('serviceName')))]",
      "resourceGroupName": "[concat(variables('resourceNamePrefix'), '-rg')]",
      "databaseName": "[concat(variables('resourceNamePrefix'), '-db')]",
      "apiAppServiceName": "[concat(variables('resourceNamePrefix'), 'api-as')]",
      "functionAppName": "[concat(variables('resourceNamePrefix'), '-fa')]",
      "appServicePlanName": "[concat(variables('resourceNamePrefix'), '-asp')]",
      "configNames": "SFA.DAS.ApprenticeProgress.Api"
  },
  "resources": [
      {
          "apiVersion": "2021-04-01",
          "name": "[variables('resourceGroupName')]",
          "type": "Microsoft.Resources/resourceGroups",
          "location": "[parameters('resourceGroupLocation')]",
          "tags": "[parameters('tags')]",
          "properties": {}
      },
      {
          "apiVersion": "2021-04-01",
          "name": "[concat(variables('apiAppServiceName'), '-app-service-certificate-', parameters('utcValue'))]",
          "type": "Microsoft.Resources/deployments",
          "resourceGroup": "[parameters('sharedEnvResourceGroup')]",
          "properties": {
              "mode": "Incremental",
              "templateLink": {
                  "uri": "[concat(variables('deploymentUrlBase'),'app-service-certificate.json')]",
                  "contentVersion": "1.0.0.0"
              },
              "parameters": {
                  "keyVaultCertificateName": {
                      "value": "[parameters('keyVaultCertificateName')]"
                  },
                  "keyVaultName": {
                      "value": "[parameters('sharedKeyVaultName')]"
                  },
                  "keyVaultResourceGroup": {
                      "value": "[parameters('sharedManagementResourceGroup')]"
                  }
              }
          }
      },
      {
          "apiVersion": "2021-04-01",
          "name": "[concat(variables('apiAppServiceName'), '-application-insights-', parameters('utcValue'))]",
          "type": "Microsoft.Resources/deployments",
          "resourceGroup": "[variables('resourceGroupName')]",
          "properties": {
              "mode": "Incremental",
              "templateLink": {
                  "uri": "[concat(variables('deploymentUrlBase'),'application-insights.json')]",
                  "contentVersion": "1.0.0.0"
              },
              "parameters": {
                  "appInsightsName": {
                      "value": "[variables('apiAppServiceName')]"
                  },
                  "attachedService": {
                      "value": "[variables('apiAppServiceName')]"
                  },
                  "logAnalyticsWorkspaceId": {
                      "value": "[resourceId(parameters('logAnalyticsSubscriptionId'),parameters('sharedManagementResourceGroup'),'Microsoft.OperationalInsights/workspaces',parameters('logAnalyticsWorkspaceName'))]"
                  }
              }
          },
          "dependsOn": [
              "[variables('resourceGroupName')]"
          ]
      },
      {
          "apiVersion": "2021-04-01",
          "name": "[concat(variables('apiAppServiceName'), '-', parameters('utcValue'))]",
          "type": "Microsoft.Resources/deployments",
          "resourceGroup": "[variables('resourceGroupName')]",
          "properties": {
              "mode": "Incremental",
              "templateLink": {
                  "uri": "[concat(variables('deploymentUrlBase'),'app-service-v2.json')]",
                  "contentVersion": "1.0.0.0"
              },
              "parameters": {
                  "appServiceName": {
                      "value": "[variables('apiAppServiceName')]"
                  },
                  "appServicePlanName": {
                      "value": "[parameters('sharedBackEndAppServicePlanName')]"
                  },
                  "appServicePlanResourceGroup": {
                      "value": "[parameters('sharedEnvResourceGroup')]"
                  },
                  "subnetResourceId": {
                      "value": "[parameters('sharedBackEndSubnetResourceId')]"
                  },
                  "appServiceAppSettings": {
                      "value": {
                          "array": [
                              {
                                  "name": "EnvironmentName",
                                  "value": "[parameters('environmentName')]"
                              },
                              {
                                  "name": "ConfigurationStorageConnectionString",
                                  "value": "[parameters('configurationStorageConnectionString')]"
                              },
                              {
                                  "name": "ASPNETCORE_ENVIRONMENT",
                                  "value": "[toUpper(parameters('environmentName'))]"
                              },
                              {
                                  "name": "ConfigNames",
                                  "value": "[variables('configNames')]"
                              },
                              {
                                  "name": "Version",
                                  "value": "1.0"
                              },
                              {
                                  "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                                  "value": "[reference(concat(variables('apiAppServiceName'), '-application-insights-', parameters('utcValue'))).outputs.ConnectionString.value]"
                              },
                              {
                                  "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
                                  "value": "[reference(concat(variables('apiAppServiceName'), '-application-insights-', parameters('utcValue'))).outputs.InstrumentationKey.value]"
                              },
                              {
                                  "name": "LoggingRedisConnectionString",
                                  "value": "[parameters('loggingRedisConnectionString')]"
                              },
                              {
                                  "name": "LoggingRedisKey",
                                  "value": "[parameters('loggingRedisKey')]"
                              }
                          ]
                      }
                  },
                  "customHostName": {
                      "value": "[parameters('customHostname')]"
                  },
                  "certificateThumbprint": {
                      "value": "[reference(concat(variables('apiAppServiceName'), '-app-service-certificate-', parameters('utcValue'))).outputs.certificateThumbprint.value]"
                  },
                  "ipSecurityRestrictions": {
                      "value": "[parameters('backEndAccessRestrictions')]"
                  }
              }
          },
          "dependsOn": [
              "[variables('resourceGroupName')]"
          ]
      },
      {
          "apiVersion": "2021-04-01",
          "name": "[concat(variables('databaseName'), '-', parameters('utcValue'))]",
          "type": "Microsoft.Resources/deployments",
          "resourceGroup": "[parameters('sharedEnvResourceGroup')]",
          "properties": {
              "mode": "Incremental",
              "templateLink": {
                  "uri": "[concat(variables('deploymentUrlBase'),'sql-database.json')]",
                  "contentVersion": "1.0.0.0"
              },
              "parameters": {
                  "databaseName": {
                      "value": "[variables('databaseName')]"
                  },
                  "sqlServerName": {
                      "value": "[parameters('sharedSQLServerName')]"
                  },
                  "elasticPoolName": {
                      "value": "[parameters('elasticPoolName')]"
                  },
                  "databaseSkuName": {
                      "value": "[parameters('databaseSkuName')]"
                  },
                  "databaseTier": {
                      "value": "[parameters('databaseTier')]"
                  },
                  "logAnalyticsSubscriptionId": {
                      "value": "[parameters('logAnalyticsSubscriptionId')]"
                  },
                  "logAnalyticsResourceGroup": {
                      "value": "[parameters('sharedManagementResourceGroup')]"
                  },
                  "logAnalyticsWorkspaceName": {
                      "value": "[parameters('logAnalyticsWorkspaceName')]"
                  }
              }
          }
      },
      {
          "apiVersion": "2020-06-01",
          "name": "[concat(variables('apiAppServiceName'), '-role-assignment-', parameters('utcValue'))]",
          "type": "Microsoft.Resources/deployments",
          "resourceGroup": "[parameters('sharedEnvResourceGroup')]",
          "properties": {
              "mode": "Incremental",
              "templateLink": {
                  "uri": "[concat(variables('deploymentUrlBase'),'role-assignments/role-assignment-service-bus.json')]",
                  "contentVersion": "1.0.0.0"
              },
              "parameters": {
                  "principalId": {
                      "value": "[reference(concat(variables('apiAppServiceName'), '-', parameters('utcValue'))).outputs.managedServiceIdentityId.value]"
                  },
                  "assignmentType": {
                      "value": "ServiceBusOwner"
                  },
                  "resourceName": {
                      "value": "[parameters('sharedServiceBusName')]"
                  }
              }
          }
      },
      {
          "apiVersion": "2020-10-01",
          "name": "[concat(parameters('subnetObject').name, '-', parameters('utcValue'))]",
          "type": "Microsoft.Resources/deployments",
          "resourceGroup": "[parameters('sharedEnvResourceGroup')]",
          "properties": {
              "mode": "Incremental",
              "templateLink": {
                  "uri": "[concat(variables('deploymentUrlBase'),'subnet.json')]",
                  "contentVersion": "1.0.0.0"
              },
              "parameters": {
                  "virtualNetworkName": {
                      "value": "[parameters('sharedEnvVirtualNetworkName')]"
                  },
                  "subnetName": {
                      "value": "[parameters('subnetObject').name]"
                  },
                  "subnetAddressPrefix": {
                      "value": "[parameters('subnetObject').addressSpace]"
                  },
                  "serviceEndpointList": {
                      "value": "[parameters('subnetServiceEndpointList')]"
                  },
                  "delegations": {
                      "value": "[parameters('subnetDelegations')]"
                  }
              }
          },
          "dependsOn": [
              "[variables('resourceGroupName')]"
          ]
      },
      {
          "apiVersion": "2020-10-01",
          "name": "[concat(variables('appServicePlanName'), '-', parameters('utcValue'))]",
          "type": "Microsoft.Resources/deployments",
          "resourceGroup": "[variables('resourceGroupName')]",
          "properties": {
              "mode": "Incremental",
              "templateLink": {
                  "uri": "[concat(variables('deploymentUrlBase'),'app-service-plan.json')]",
                  "contentVersion": "1.0.0.0"
              },
              "parameters": {
                  "appServicePlanName": {
                      "value": "[variables('appServicePlanName')]"
                  },
                  "aspSize": {
                      "value": "[parameters('appServicePlanSize')]"
                  },
                  "aspInstances": {
                      "value": "[parameters('appServicePlanInstances')]"
                  }
              }
          },
          "dependsOn": [
              "[variables('resourceGroupName')]"
          ]
      },
      {
          "apiVersion": "2020-10-01",
          "name": "[concat(variables('functionAppName'), '-application-insights-', parameters('utcValue'))]",
          "type": "Microsoft.Resources/deployments",
          "resourceGroup": "[variables('resourceGroupName')]",
          "properties": {
              "mode": "Incremental",
              "templateLink": {
                  "uri": "[concat(variables('deploymentUrlBase'),'application-insights.json')]",
                  "contentVersion": "1.0.0.0"
              },
              "parameters": {
                  "appInsightsName": {
                      "value": "[variables('functionAppName')]"
                  },
                  "attachedService": {
                      "value": "[variables('functionAppName')]"
                  }
              }
          },
          "dependsOn": [
              "[variables('resourceGroupName')]"
          ]
      },
      {
          "apiVersion": "2020-10-01",
          "name": "[concat(variables('functionAppName'), '-', parameters('utcValue'))]",
          "type": "Microsoft.Resources/deployments",
          "resourceGroup": "[variables('resourceGroupName')]",
          "properties": {
              "mode": "Incremental",
              "templateLink": {
                  "uri": "[concat(variables('deploymentUrlBase'),'function-app-v2.json')]",
                  "contentVersion": "1.0.0.0"
              },
              "parameters": {
                  "functionAppName": {
                      "value": "[variables('functionAppName')]"
                  },
                  "appServicePlanName": {
                      "value": "[variables('appServicePlanName')]"
                  },
                  "appServicePlanResourceGroup": {
                      "value": "[variables('resourceGroupName')]"
                  },
                  "subnetResourceId": {
                      "value": "[reference(concat(parameters('subnetObject').name, '-', parameters('utcValue'))).outputs.SubnetResourceId.value]"
                  },
                  "functionAppAppSettings": {
                      "value": {
                          "array": [
                              {
                                  "name": "EnvironmentName",
                                  "value": "[parameters('environmentName')]"
                              },
                              {
                                  "name": "ConfigurationStorageConnectionString",
                                  "value": "[parameters('configurationStorageConnectionString')]"
                              },
                              {
                                  "name": "ConfigNames",
                                  "value": "[parameters('functionConfigNames')]"
                              },
                              {
                                  "name": "Version",
                                  "value": "1.0"
                              },
                              {
                                  "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                                  "value": "[reference(concat(variables('functionAppName'), '-application-insights-', parameters('utcValue'))).outputs.ConnectionString.value]"
                              },
                              {
                                  "name": "AzureWebJobsStorage",
                                  "value": "[parameters('sharedStorageAccountConnectionString')]"
                              },
                              {
                                  "name": "FUNCTIONS_EXTENSION_VERSION",
                                  "value": "~4"
                              },
                              {
                                  "name": "FUNCTIONS_WORKER_RUNTIME",
                                  "value": "dotnet-isolated"
                              },
                              {
                                  "name": "WEBSITE_RUN_FROM_PACKAGE",
                                  "value": "1"
                              },
                              {
                                  "name": "AzureWebJobsServiceBus__fullyQualifiedNamespace",
                                  "value": "[parameters('SharedServiceBusFqdn')]"
                              },
                              {
                                "name": "AzureWebJobsServiceBus",
                                "value": "[parameters('serviceBusConnectionString')]"
                              }
                          ]
                      }
                  },
                  "ipSecurityRestrictions": {
                      "value": "[parameters('workerAccessRestrictions')]"
                  }
              }
          },
          "dependsOn": [
              "[variables('resourceGroupName')]",
              "[concat(variables('appServicePlanName'), '-', parameters('utcValue'))]"
          ]
      },
      {
          "apiVersion": "2020-06-01",
          "name": "[concat(variables('functionAppName'), '-role-assignment-',parameters('utcValue'))]",
          "type": "Microsoft.Resources/deployments",
          "resourceGroup": "[parameters('sharedEnvResourceGroup')]",
          "properties": {
              "mode": "Incremental",
              "templateLink": {
                  "uri": "[concat(variables('deploymentUrlBase'),'role-assignments/role-assignment-service-bus.json')]",
                  "contentVersion": "1.0.0.0"
              },
              "parameters": {
                  "principalId": {
                      "value": "[reference(concat(variables('functionAppName'), '-', parameters('utcValue'))).outputs.managedServiceIdentityId.value]"
                  },
                  "assignmentType": {
                      "value": "ServiceBusOwner"
                  },
                  "resourceName": {
                      "value": "[parameters('sharedServiceBusName')]"
                  }
              }
          }
      }
  ],
  "outputs": {
      "AppServiceName": {
          "type": "string",
          "value": "[variables('apiAppServiceName')]"
      },
      "FunctionAppName": {
          "type": "string",
          "value": "[variables('functionAppName')]"
      },
      "ResourceGroupName": {
          "type": "string",
          "value": "[variables('resourceGroupName')]"
      },
      "DatabaseName": {
          "type": "string",
          "value": "[variables('databaseName')]"
      }
  }
}